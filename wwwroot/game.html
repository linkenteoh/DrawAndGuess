<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=520, initial-scale=1.0">
    <title>DrawRT 3.0</title>
    <link href="image/favicon.png" rel="shortcut icon">
    <link href="css/app.css" rel="stylesheet">
    <style>
        main{
            margin: 0px auto;
        }
        #box {
            border: 1px solid #999;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #pen {
            background: #000;
            border: 1px solid #000;
            border-radius: 50%;
            width: 5px;
            height: 5px;
        }

        #panel {
            width: 500px;
            margin-bottom: 10px;
            display: flex;
        }

        #size {
            flex: 1 1 auto;
        }

        #color {
            width: 60px;
            height: auto;
        }

        #canvas {
            display: block;
            border: 1px solid #999;
            cursor: pointer;
            touch-action: none;
            user-select: none;
        }

        .canvas{
            float:left;
        }

        .board, .chat {
            float:left;
            margin: 0px 10px 0px 10px;
        }
    </style>
</head>

<body>
    <header>
        <h2><a href="/">Drawlah</a></h2>
        <h5 id="username"></h5>
    </header>

    <!-- TODO: Hide <main> section by default -->
    <main hidden style="padding-top: 0px;">
            

        <div class="board">
            <div class="board-header">
                <p>Players </p>
            </div>
            <div class="board-body">
                <ol id="onlinePlayers">
                    
                </ol>
            </div>
        </div>

        <div class="canvas">
            <div class="canvas-header">
               <h2 id="question"></h2>
            </div>
            <div class="canvas-body">
                <canvas id="canvas" width="700" height="700">
                    
                </canvas>
                <div id="loadState">
                    <div id="overlay" style="opacity: 0;"></div>
                    <div id="waitText"><p class="loading"></p></div>
                </div>

                <div id="panel" style="display: none;">
                    <div id="box">
                        <div id="pen"></div>
                    </div>

                    <input type="range" id="size" min="1" max="30" step="1" value="5" list="ticks">
                    <datalist id="ticks">
                        <option value="5">
                        <option value="10">
                        <option value="15">
                        <option value="20">
                        <option value="25">
                        <option value="30">
                    </datalist>

                    <input type="color" id="color" list="colors">
                    <datalist id="colors">
                        <option value="#ff0000">
                        <option value="#ffa500">
                        <option value="#ffff00">
                        <option value="#008000">
                        <option value="#0000ff">
                        <option value="#4b0082">
                        <option value="#ee82ee">
                        <option value="#000000">
                        <option value="#ffffff">
                        <option value="#999999">
                    </datalist>

                    <button id="clear">üóëÔ∏è</button>

                    <button id="image">üñºÔ∏è</button>
                    <input type="file" id="file" accept="image/*" hidden>

                    <button id="download">üíæ</button>
                </div>
                <div id="app" hidden></div>
            </div>
            
        </div>
        <audio id="timer-beep">
            <source src="10-Second-Countdown-Beeping-Tones-www.fesliyanstudios.com.mp3"/>
          </audio>

        <div class="chat">
            <div class="board-header">
                <p style="width: 120px;">Messages</p>
            </div>
            <div class="msgBar">
                <div class="messages">
                    <ul id="msg">
                        
                    </ul>
                </div>
                <hr style="margin: 0px;">
                <div id="chatbox">
                    <form id="chatForm">
                        <input id="chatInput" placeholder="Guess and Chat" style="border: 0px;" autocomplete="off">
                    </form>
                </div>
            </div>
        </div>

        
    </main>

    <script src="js/timer.js"></script>
    <script src="js/jquery.slim.js"></script>
    <script src="js/signalr.js"></script>
    <script>
        // (1) Interactive UI Events ==============================================================
        $('#size').on('input', e => { 
            let size = $('#size').val();
            $('#pen').width(size).height(size);
        });

        $('#color').on('input', e => {
            let color = $('#color').val();
            $('#pen').css('background', color);
        });

        $('#size, #color').trigger('input');

        $('#canvas').on('wheel', e => {
            e.preventDefault();
            let dy = e.originalEvent.deltaY;
            if (dy < 0) {
                $('#size')[0].stepUp();
            }
            else {
                $('#size')[0].stepDown();
            }
            $('#size').trigger('input');
        });

        $(document).keydown(e => {
            if (e.originalEvent.repeat) return;

            switch (e.key) {
                case '0': $('#clear').click(); break;
                case '1': $('#color').val('#ff0000'); break;
                case '2': $('#color').val('#ffa500'); break;
                case '3': $('#color').val('#ffff00'); break;
                case '4': $('#color').val('#008000'); break;
                case '5': $('#color').val('#0000ff'); break;
                case '6': $('#color').val('#4b0082'); break;
                case '7': $('#color').val('#ee82ee'); break;
                case '8': $('#color').val('#000000'); break;
                case '9': $('#color').val('#ffffff'); break;
            }
            $('#color').trigger('input');
        });

        // (2) General Functions ==================================================================
        const can = $('#canvas')[0];
        const ctx = can.getContext('2d');


        const username = sessionStorage.getItem('username');

        if(username){ //If session storage aldy having an username -- handles page reloading
            $('#username').text(username);
        }
        else
        {
            location = 'index.html';
            throw 'ERROR: Invalid username';
        }

        //Chat functions 
        $('#chatForm').submit(e => {
            e.preventDefault();
            let msg = $('#chatInput').val().trim();
            if(msg){
                con.invoke('SendText', gameId, msg, name);
            }
            $('#chatInput').val('');
        });

        ctx.lineCap    = 'round';
        ctx.lineJoin   = 'round';
        ctx.shadowBlur = 0;
        clear();

        function drawLine(a, b, size, color) {
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.lineWidth = size;
            ctx.strokeStyle = color;
            ctx.shadowColor = color;
            ctx.stroke();
        }

        function drawCurve(a, b, c, size, color) {
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.quadraticCurveTo(b.x, b.y, c.x, c.y);
            ctx.lineWidth = size;
            ctx.strokeStyle = color;
            ctx.shadowColor = color;
            ctx.stroke();
        }

        function clear() {
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, can.width, can.height);
        }

        // TODO: Convert to promise (awaitable function)
        function drawImage(url) {
            return new Promise(resolve => {
                let img = new Image();
                img.onload = e => {
                    ctx.drawImage(img, 0, 0);
                    resolve();
                };
                img.src = url;
            });
        }

        function mid(a, b) {
            return { x: (a.x + b.x) / 2, y: (a.y + b.y) / 2 };
        }

        // TODO: Awaitable sleep function
        function sleep(ms){
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // (3) Draw Events ========================================================================
        
        let arr = [];

        $('#canvas').on('pointermove pointerout', e => {
            if (e.buttons == 1 && e.originalEvent.isPrimary) {
                let size  = $('#size').val() * 1;
                let color = $('#color').val();

                // 1. Add start point (if needed)
                if (arr.length == 0) {
                    arr.push({ x: e.offsetX - e.originalEvent.movementX, y: e.offsetY - e.originalEvent.movementY });
                }
                
                // 2. Add new point
                arr.push({ x: e.offsetX, y: e.offsetY });
                arr = arr.slice(-3); // Keep last 3 points only

                if (arr.length >= 3) {
                    // arr = [0, 1, 2]
                    let a = mid(arr[0], arr[1]);
                    let b = arr[1];
                    let c = mid(arr[1], arr[2]);
                    drawCurve(a, b, c, size, color);
                    // TODO(A): Hub method
                    con.invoke('SendCurve', a, b, c, size, color, gameId);
                }
                else {
                    // arr = [0, 1]
                    let a = arr[0];
                    let b = mid(arr[0], arr[1]);
                    drawLine(a, b, size, color);
                    // TODO(B): Hub method
                    con.invoke('SendLine', a, b, size, color, gameId);
                }
            }
        });

        $('#canvas').on('pointerup pointerout', e => {
            if (arr.length >= 2) {
                arr = arr.slice(-2); // Keep last 2 points only

                let size  = $('#size').val() * 1;
                let color = $('#color').val();

                // arr = [0, 1]
                let a = mid(arr[0], arr[1]);
                let b = arr[1];
                drawLine(a, b, size, color);
                // TODO(C): Hub method
                con.invoke('SendLine', a, b, size, color, gameId);
            }
            arr = [];
        });

        $('#clear').click(e => {
            clear();
            // TODO(D): Hub method
            con.invoke('SendClear', gameId);

        });

        $('#download').click(e => {
            let a = $('<a>')[0];
            a.href = can.toDataURL('image/png') ;
            a.download = Date.now() + '.png';
            a.click();
        });

        // (4) SignalR ============================================================================
        const name = sessionStorage.getItem('username');
        const gameId = new URL(location).searchParams.get('gameId');

        const param = $.param({ page: 'game', name, gameId });

        const con = new signalR.HubConnectionBuilder()
            .withUrl('/hub?' + param)
            .build();

        con.onclose(err => {
            alert('Disconnected');
            location = '/';
        });

        con.on('ReceiveLine', drawLine);
        con.on('ReceiveCurve', drawCurve);
        con.on('ReceiveImage', drawImage);
        con.on('ReceiveClear', clear);

        con.on('UpdatePlayers', players => { //Call when user first join the room - to retrieve lists of players connected
            console.log(players);
            var html = "";
            for(let i = 0; i < players.length; i ++){
                console.log(players[i].name);
                html += `<li>${players[i].name}  | ${players[i].score}pts</li>`;
            }
                // $('#onlinePlayers').append(`
                //     <li>
                //         ${name}
                //     </li>
                // `);
            $('#onlinePlayers')[0].innerHTML = html;
            
        });


        con.on('Left', name => { //Call when user left the room
            $('#onlinePlayers li:contains('+name+')').remove();
        });

        con.on('ReceiveText', (name, msg, type) => {
            if(type == "NormalChat")
            {
                msg = msg
                .split(':)').join('üòä')
                .split(':(').join('üò•')
                .split('<3').join('‚ù§Ô∏è');
                $('#msg').append(`<li>${name}: ${msg}</li>`);
            }
            else if(type == "Ans")
            {
                $('#msg').append(`<li>${name} ${msg}</li>`);
            }
            else if(type == "OwnGuess")
            {
                $('#msg').append(`<li>${msg}</li>`);
            }
            
        });

        con.on('Reject', () => location = 'index.html');

        con.on('PlayerJoined', game => {
            if(game.isFull){
                con.invoke('Start', 0);
            }else{
                $('.loading').text("Waiting for others to join");
            }
        });

        function test(){
            startTimer();
            $('#app').show();
        }

        con.on('Start', function(game, conId, drawIndex) {
            console.log('Noindex:' + drawIndex);
            if(drawIndex > game.noPlayers){
                alert('Game ends');
                return;
            }

            
            startTimer();
            $('#app').show();
            $('#waitText').hide();
            //$('#panel').show();
            console.log(game);
            for(var player in game.players) 
            {
                var player = game.players[player];
                //console.log(player);
                if(player.isDrawing == true)
                {
                    // document.getElementById("drawingName").innerHTML = player.name + 'is drawing ';
                    $('#question')[0].innerHTML = player.name + ' is drawing ';
                    $('#question')[0].append(game.question);
                    //$('#question')[0].append(game.question.replace(/./g, '_ '));
                }

                if(player.id == conId && player.isDrawing == true)
                {
                    $('.loading').text("You are drawing!");
                    $('#waitText').show();
                    setTimeout(function(){ $('#loadState').hide(); }, 2000);
                    $('#panel').show();

                }
                else if(player.id == conId && player.isDrawing == false)
                {
                    $('#loadState').show();
                    $('#panel').hide();

                }

            }
            con.invoke('SendClear', gameId); //Clear canvas after each player's turn
            drawIndex++;
            
            setTimeout(function(){
                        con.invoke('Start', drawIndex);
                     }, 15000); //Alowing users 60 seconds to draw then chg nxt player
        });


        con.on('DrawText', (player) => {
            player++;
            $('.loading').text("You are drawing!");
            $('#waitText').show();
            setTimeout(function(){ $('#loadState').hide(); }, 2000);
            $('#panel').show();            
            setTimeout(function(){ con.invoke('Start', player);$('#loadState').show(); $('#panel').hide }, 15000);
        });

        con.on("StartTimer", () => {
            //startTimer();
            //$('#app').show();
        });

        con.on("END", () => {
            //startTimer();
            //$('#app').show();
            alert('GameENDS!');
        })


        con.start().then(() => {
            $('main').show();
        });
        
    </script>
</body>
</html>